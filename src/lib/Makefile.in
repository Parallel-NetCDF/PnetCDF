#
#  Copyright (C) 2012, Northwestern University and Argonne National Laboratory
#  See COPYRIGHT notice in top-level directory.
#
# $Id$
#
#	Makefile for netcdf libsrc
#

srcdir = @srcdir@
VPATH = @srcdir@
INSTALL = @INSTALL@

# generated by configure, so it's in the build dir, not srcdirr
include ../../macros.make

INCLUDES = -I. 

LIBRARY 	= libpnetcdf.a
PROGRAM		= ncvalid
ld_netcdf	= -L. -lpnetcdf

HEADER	= pnetcdf.h

MANUAL	= pnetcdf.3

LIB_CSRCS = \
	mpinetcdf.c \
	header.c \
	mpincio.c \
	attr.c \
	dim.c \
	error.c \
	nc.c \
	ncx.c \
	string.c \
	var.c \
	ncmpidtype.c \
	convert_swap.c \
	filetype.c \
	getput_var.c \
	getput_var1.c \
	getput_vara.c \
	getput_vars.c \
	getput_varm.c \
	i_getput_var.c \
	i_getput_var1.c \
	i_getput_vara.c \
	i_getput_vars.c \
	i_getput_varm.c \
	m_getput_varx.c \
	nonblocking.c   \
        malloc.c \
	utf8proc.c \
	getputn_schar.c \
	getputn_uchar.c \
	getputn_short.c \
	getputn_ushort.c \
	getputn_int.c \
	getputn_uint.c \
	getputn_float.c \
	getputn_double.c \
	getputn_int64.c \
	getputn_uint64.c \
	swap.c \
	bput_var.c \
	bput_var1.c \
	bput_vara.c \
	bput_vars.c \
	bput_varm.c

PACKING_LIST = \
	$(LIB_CSRCS) \
	depend \
	fbits.h \
	Makefile \
	nc.h \
	ncconfig.in \
	ncio.h \
	ncx.h \
	pnetcdf.3 \
	pnetcdf.h \
	rnd.h \
	ncmpidtype.h \
	macro.h \
	utf8proc_data.h \
	utf8proc.h

LIB_OBJS = $(LIB_CSRCS:.c=.o)

PROG_CSRCS = validator.c

PROG_OBJS = $(PROG_CSRCS:.c=.o)

GARBAGE		= $(LIBRARY) $(MANUAL) $(PROGRAM)

DIST_GARBAGE	= ncconfig.h pnetcdf.h


all:		$(LIBRARY) $(MANUAL) $(PROGRAM)

install:
	$(INSTALL) -d -m 755 $(LIBDIR)
	$(INSTALL) -m 644 $(LIBRARY) $(LIBDIR)/$(LIBRARY)

	$(INSTALL) -d -m 755 $(INCDIR)
	$(INSTALL) -m 644 $(HEADER) $(INCDIR)/$(HEADER)

	$(INSTALL) -d -m 755 $(MANDIR)/man3
	$(INSTALL) -m 644 $(MANUAL) $(MANDIR)/man3/$(MANUAL)

	$(INSTALL) -d -m 755 $(BINDIR)
	$(INSTALL) -m 755 $(PROGRAM) $(BINDIR)/$(PROGRAM)

uninstall:
	$(RM) -f $(LIBDIR)/$(LIBRARY)
	$(RM) -f $(INCDIR)/$(HEADER)
	$(RM) -f $(MANDIR)/man3/$(MANUAL)
	$(RM) -f $(BINDIR)/$(PROGRAM)



# The rule for generating the manual page is here for completeness only.
# The manual page is actually part of the distribution so that we don't
# have to depend on the non-POSIX utility m4(1).
#
$(MANUAL):	$(srcdir)/../../man/netcdf.m4
	$(M4) $(M4FLAGS) -DAPI=C $? >$@  || $(RM) -f $@

$(PROGRAM):	$(PROG_OBJS) $(LIBRARY)
	$(LINK.c) $(PROG_OBJS) $(LIBRARY)

include $(srcdir)/../../rules.make

.SUFFIXES: .ln
LINT = lint
LINT.c = $(LINT) $(LINTFLAGS) $(CPPFLAGS)
.c.ln:
	$(LINT.c) -c $<

llib-lpnetcdf.ln: $(LIB_CSRCS)
	$(LINT.c) $(LIB_CSRCS) -y -o pnetcdf

lint: llib-lpnetcdf.ln
	$(LINT.c) t_nc.c llib-lpnetcdf.ln

include $(srcdir)/depend
