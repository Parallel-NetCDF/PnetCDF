# Support ADIOS BP files

Starting from version 1.12.0, PnetCDF supports reading data from ADIOS 1.x BP files. 
Through calling PnetCDF APIs, this feature allows applications to
read files in BP format. For now, PnetCDF cannot write to BP formated files.

## Enable ADIOS support

PnetCDF requires a ADIOS library (https://www.olcf.ornl.gov/center-projects/adios/) that is built with parallel I/O support.
* To build PnetCDF with ADIOS support
  + Add `--enable-adios` option at the configure command line. Option
    `--with-adios` can be used to specify the installation path of ADIOS.
    For example,
    ```
    gzip -dc parallel-netcdf-1.11.0.tar.gz | tar -xf -
    cd parallel-netcdf-1.11.0
    ./configure --prefix=/PnetCDF/install/path \
                --enable-adios \
                --with-adios=/ADIOS/install/path
    ```
* To build ADIOS library for the ADIOS driver
  + Download ADIOS
    git clone https://github.com/ornladios/ADIOS.git
  + Compile ADIOS
    ./configure --prefix=<install/directory>
    make install
* For detail regarding buuilding the ADIOS library, please refer to https://users.nccs.gov/~pnorbert/ADIOS-UsersManual-1.13.0.pdf
* The ADIOS driver is only tested on ADIOS 1.12 or later


## Accessing ADIOS file

For now, PnetCDF can only read BP formated file. To open a AIODS BP file, add the flag NC_NOWRITE into argument cmode when
calling `ncmpi_open()`. For example,
```
int cmode;
cmode = NC_NOWRITE;
ncmpi_open(MPI_COMM_WORLD, "testfile.bp", cmode, MPI_INFO_NULL, &ncid);
```

Setting NC_WRITE flag will result in error. PnetCDF will recognize ADIOS BP file aumatically and selects the proper I/O driver.
No flag regarding file format is required.

## Example programs

An example program is avaiable at /examples/adios/read_all.c

## Design of ADIOS driver

The ADIOS driver is a convenience wrapper of the ADIOS library that allows users to read ADIOS BP formatted file using PnetCDF API. The ADIOS driver maps ADIOS data structures to NetCDF data structures and translates NetCDF operation into corresponding ADIOS function call. It allows applications using NetCDF file format to access BP formatted files without the need to rewrite using ADIOS API. It also eliminates the need to translate BP formatted files for existing PnetCDF applications.

* Opening the file
  When an ADIOS BP formatted file is opened. The ADIOS driver parse the BP file header for metadata involving variables and dimensions because dimension information cannot be retrieved using ADIOS read API. Meanwhile, the driver opens the file using ADIOS read API for variable data and attribute reading. 
  + Determine file format
    + To our best knowledge, BP file format has no (specified) signature that can be used to recognize BP formatted files.
      ADIOS assumes files are valid and parse it according to its format specification. The file is considered invalid when any violation of the format is found during the parsing.
    + Instead of a header, the BP file format uses a footer to index the data. 
      The last 28 byte is a mini footer that contains 3 64 bits unsigned integer that represent the position of process group, variables, and attributes index table in the footer respectively followed by a 4 bytes version information. The only rule regarding the mini footer is that process group index comes before variable index and variable index comes before attributes index.
    To determine the file format, the ADIOS driver first check if the mini footer matches the BP specification. If so, the ADIOS driver tries to open the file using ADIOS read API. Should opening successes, it is considered valid BP formatted file.
  + Parsing Headers
    ADIOS distribution comes with a NetCDF conversion utility that converts BP formatted file into NetCDF file called bp2ncd. To ensure the view of BP file resented by PnetCDF is consistent with the file converted by the utility program in ADIOS distribution, we followed the representation of bp2ncd.
    We ran a modified routine of bp2ncd in which it does not actually generate NetCDF files, instead, it records every dimension and variable it tries to create. This information is used by the ADIOS driver to provide dimension information as well as metadata of variables. We noticed that the bp2ncd utility has some problem in parsing attributes. Fortunately, the ADIOS read API do present full attribute information. we use the ADIOS read API directly to access attributes.
* Querying Dimensions
  ADIOS BP file does not include data structure for dimensions, instead, dimensions are represented by special scalar variables with a flag indicating it is a dimension. However, ADIOS read API ignores the flag and present all variable as traditional variable. It is only possible to know the size of each variable using ADIOS API. The relation between variable dimensions to dimension variables is not retrievable using ADIOS read API. We use record generated by bp2ncd utility to distinguish dimensions and variable as well as their relation.
  When user query a dimension, we find in the record generated by the modified bp2ncd routine for name or ID matching the query.
  + Unlimited Dimensions
    For performance consideration, we do not record variable write from the bp2ncd utility. ADIOS read API also does not expose size of unlimited dimension. We define the size of unlimited dimension as the largest it ever appears in variable sizes returned by ADIOS read API.
* Reading Attributes
  ADIOS read API can retrieve full attribute information. We can translate PnetCDF attribute read to ADIOS attribute read directly.
  + Unlike PnetCDF where attribute can either be associated with the file (global) or a variable, ADIOS read API presents all attributes as global attribute. Attributes that is intended to be associated with a variable are indicate by giving it a path-like name with variable name as prefix. For example, an attribute X associated with variable Y will be presented as a global named /Y/X.
  + When user reads a global attribute, we pass it directly to ADIOS API. When user reads a variable attribute, we append the name of variable in question before the attribute name and pass to ADIOS read API. In this way, variable attributes can be accessed either globally using its full path or on variable with only attribute name.
* Reading Variables
  The view of ADIOS driver on variables are based on the record of bp2ncd which differs to the view given by ADIOS read API. As a result, variables are identified by name instead of ID when reading variable data using ADIOS read API.
  + Unsupported API type
    + vard: ADIOS does not allow reading variable using derived datatype
    + low-level API: ADIOS does not allow reading variable using derived datatype
    + write related API: ADIOS driver is read only
    + varn: Although it is possible simulate it by issuing multiple vara call, it wonâ€™t provide the performance advantage as the purpose of varn API. Non-blocking API are also not supported
    + non-blocking: Although ADIOS have a set of non-blocking APIs, it serves different purpose to the non-blocking API in PnetCDF and hence cannot be used to support non-blocking API in PnetCDF
  + Time step
    The BP file not only record the current state of the dataset, it records the entire history. It is presented by the concept of time steps. 
    Each time step corresponds to an open and close session. Variables can have different value on different time step.
    Since NetCDF file as well as PnetCDF API do not include such concept, the ADIOS driver always return the last (latest) time step of a variable.
  + Type conversion
    ADIOS read API always return data in origin type associate with a variable or attribute. 
    PnetCDF, on the other hand, do allow user to specify a different datatype to the variable or attribute. 
    If user specify a different type than the variable or attribute, the ADIOS driver will read the variable into a temporary buffer, and then convert the data into desired type by performing C type casting on each individual value.

## Known Problems

Some features are not supported due to the availability of APIs different
between PnetCDF and ADIOS libraries. I/O semantics are also slightly
different.

* The ADIOS driver is ready only driver. It does not support any API that creates or modifies 
  objects within the BP file.
* The ADIOS driver does not work with PnetCDF burst buffer feature due to its ready only nature.
* API families of `vard`, `varn`, derived type, and nonblocking I/O are not supported. This
  is because ADIOS does not have corresponding APIs. Error code
  `NC_ENOTSUPPORT` will be returned. For vard APIs, ADIOS does not have APIs
  that allow accessing the file directly by an MPI derived file type. For
  `varn` APIs, a potential solution is to split the request into into multiple
  vara calls. However, such solution must deal with the situation when the
  numbers of requests are different among processes in the collective data
  mode. Supporting `varn` is thus a future work.
* PnetCDF current does not recognize record dimension. Variable with record dimension can 
  still be read, but PnetCDF will not return information regarding number of records.

Copyright (C) 2018, Northwestern University and Argonne National Laboratory

See COPYRIGHT notice in top-level directory.

